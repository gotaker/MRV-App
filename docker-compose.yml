services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mrv-web
    ports:
      - "4200:4200"
      - "443:4200"    # access via https://localhost
    environment:
      - CHOKIDAR_USEPOLLING=true
      - NG_CLI_ANALYTICS=false
    volumes:
      - ./:/app
      - /app/node_modules
    command: ["npx","ng","serve","--host","0.0.0.0","--port","4200","--poll","2000","--ssl","--ssl-cert","/app/certs/dev-cert.pem","--ssl-key","/app/certs/dev-key.pem"]

  mock-api:
    image: clue/json-server:latest
    container_name: mrv-mock-api
    volumes:
      - ./mock/db.json:/data/db.json:ro
    ports:
      - "3000:80"

  # Optional Cypress runner
  e2e:
    image: cypress/included:13.13.1
    container_name: mrv-e2e
    depends_on:
      - web
    working_dir: /e2e
    environment:
      - CYPRESS_baseUrl=http://web:4200
    volumes:
      - ./:/e2e
    entrypoint: [ "bash", "-lc", "npm ci || npm install; npx cypress run" ]
    # platform: linux/amd64   # uncomment on Apple Silicon if needed
